<style>
body {
	--test-bg-color: #506;
	--test-bg-color: #916;
	--test-content-w: 380px;
	--test-content-h: 420px;
}
#testWrap {
	display: flex;
	flex-direction: column;
	gap: 10px;
}
#ctrls {
	display: flex;
	gap: 10px;
}
#ctrls button {
	flex: 1;
}
</style>

<gsui-slicer duration="8" timedivision="4/4" cropa="0" cropb="1"></gsui-slicer>
<div id="ctrls">
	<button id="loadSample">Load a sample</button>
	<button id="rmSample">Unload</button>
	<button id="playSample">Play/Stop</button>
</div>

<script>
TEST( {
	deps: [
		"gsuiIcon",
		"gsuiBeatlines",
		"gsuiWaveform",
	],
	cssFiles: [
		"gsuiDragshield/gsuiDragshield.css",
		"gsuiIcon/gsuiIcon.css",
		"gsuiBeatlines/gsuiBeatlines.css",
		"gsuiSlicer/gsuiSlicer.colors.default.css",
		"gsuiSlicer/gsuiSlicer.css",
	],
	jsFiles: [
		"gsuiDragshield/gsuiDragshield.js",
		"gsuiWaveform/gsuiWaveform.js",
		"gsuiWaveform/gsuiWaveform.draw.js",
		"gsuiBeatlines/gsuiBeatlines.js",
		"gsuiSlicer/gsuiSlicer.html.js",
		"gsuiSlicer/gsuiSlicer.js",
	],
	js: () => {
		const slicer = document.querySelector( "gsui-slicer" ),
			rmSampleBtn = document.querySelector( "#rmSample" ),
			loadSampleBtn = document.querySelector( "#loadSample" ),
			playSampleBtn = document.querySelector( "#playSample" );
		let ctx, buffer, absn;

		slicer.addSlice(  0, { x: .000, y: .000, w: .125 } );
		slicer.addSlice(  1, { x: .125, y: .125, w: .125 } );
		slicer.addSlice(  2, { x: .250, y: .250, w: .125 } );
		slicer.addSlice(  3, { x: .375, y: .375, w: .125 } );
		slicer.addSlice(  4, { x: .500, y: .500, w: .125 } );
		slicer.addSlice(  5, { x: .625, y: .625, w: .125 } );
		slicer.addSlice(  6, { x: .750, y: .750, w: .125 } );
		slicer.addSlice(  7, { x: .875, y: .875, w: .125 } );

		function buildBuffer() {
			const cropA = +slicer.getAttribute( "cropa" );
			const cropB = +slicer.getAttribute( "cropb" );
			const bufCropA = cropA * buffer.length | 0;
			const newlen = ( cropB - cropA ) * buffer.length | 0;
			const newbuf = ctx.createBuffer( buffer.numberOfChannels, newlen, ctx.sampleRate );

			Object.values( slicer.getSlicesData() ).forEach( sli => {
				const obj = {
					sampleRate: ctx.sampleRate,
					srcInd: bufCropA + ( sli.x - ( sli.x - sli.y ) ) * newlen | 0,
					dstInd: sli.x * newlen | 0,
					cpyLen: sli.w * newlen | 0,
				};

				for ( let i = 0; i < buffer.numberOfChannels; ++i ) {
					obj.srcArr = buffer.getChannelData( i );
					obj.dstArr = newbuf.getChannelData( i );
					copyBuffer( obj );
				}
			} );
			return newbuf;
		}

		function copyBuffer( { srcArr, srcInd, dstArr, dstInd, cpyLen, sampleRate } ) {
			for ( let i = 0; i < cpyLen; ++i ) {
				dstArr[ dstInd + i ] = srcInd + i < srcArr.length
					? srcArr[ srcInd + i ] * envBuffer( i, cpyLen, sampleRate * .01, sampleRate * .01 )
					: 0;
			}
		}

		function envBuffer( i, len, att, rel ) {
			return i < len / 2
				? Math.min( i, att ) / att
				: Math.min( len - 1 - i, rel ) / rel;
		}

		GSUI.listenEvents( slicer, {
			gsuiSlicer: {
				cropA: () => {
					playSampleBtn.onclick();
					playSampleBtn.onclick();
				},
				cropB: () => {
					playSampleBtn.onclick();
					playSampleBtn.onclick();
				},
				changeSlices: ( d, t, e ) => {
					playSampleBtn.onclick();
					playSampleBtn.onclick();
				},
			},
		} );

		playSampleBtn.onclick = () => {
			if ( absn ) {
				absn.stop();
				absn = null;
			} else {
				absn = ctx.createBufferSource();
				absn.buffer = buildBuffer();
				absn.loop = true;
				absn.connect( ctx.destination );
				absn.start();
			}
		};
		rmSampleBtn.onclick = () => slicer.removeBuffer();
		loadSampleBtn.onclick = () => {
			ctx = ctx || new AudioContext();
			slicer.removeBuffer();
			// fetch( "test-assets/i-just-dont-know-why_F_minor.wav" )
			// fetch( "test-assets/the_purge_siren_3.wav" )
			// fetch( "test-assets/mental-help-hotline.m4a" )
			// fetch( "test-assets/still-listening-gentleman.wav" )
			// fetch( "test-assets/56k.ogg" )
			// fetch( "test-assets/LCU_808_180_DLKit_03_Full.wav" )
			fetch( "test-assets/Too Long - Steam Machine.wav" )
			// fetch( "test-assets/Robot Rock - Oh Yeah.wav" )
			// fetch( "test-assets/Television Rules The Nation - Crescendolls.wav" )
				.then( res => res.arrayBuffer() )
				.then( arr => ctx.decodeAudioData( arr ) )
				.then( buf => {
					buffer = buf;
					slicer.setBuffer( buf );
					slicer.setBufferName( "my-super-sample" );
				} );
		};
	},
} );
</script>
